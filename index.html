
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');

    body {
      font-family: 'Kanit', sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem 1.5rem 3rem;
      background: linear-gradient(135deg, #bbdefb 0%, #e3f2fd 100%);
      color: #0a3d62;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      border-radius: 15px;
    }

    h1 {
      font-weight: 700;
      font-size: 2.4rem;
      margin-bottom: 0.25rem;
      color: #0984e3;
    }

    #logo {
      width: 150px;
      margin: 0 auto 1rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
      border-radius: 10px;
    }

    p.description {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 1.8rem;
      color: #3742fa;
      font-weight: 500;
      user-select: none;
    }

    select, input[type="text"] {
      width: 48%;
      padding: 0.7rem 1rem;
      font-size: 1.1rem;
      border-radius: 10px;
      border: 2px solid #74b9ff;
      margin: 0.3rem 1% 1rem;
      outline-offset: 2px;
      transition: border-color 0.3s ease;
    }
    select:focus, input[type="text"]:focus {
      border-color: #0984e3;
      box-shadow: 0 0 8px #74b9ff80;
    }

    div.buttons {
      margin: 1.5rem 0 0.5rem;
    }

    button {
      background: #0984e3;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 0.85rem 1.8rem;
      font-size: 1.1rem;
      margin: 0 0.4rem 0.8rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 5px 10px rgb(9 132 227 / 0.4);
    }
    button:hover:not(:disabled) {
      background: #74b9ff;
      box-shadow: 0 6px 15px rgb(116 185 255 / 0.7);
    }
    button:disabled {
      background: #dfe6e9;
      color: #7f8c8d;
      cursor: not-allowed;
      box-shadow: none;
    }

    #visualizer {
      width: 100%;
      height: 80px;
      border-radius: 10px;
      margin: 1.5rem 0 1.8rem;
      background: #dfe6e9;
      box-shadow: inset 0 0 10px #b2bec3;
    }

    audio {
      width: 100%;
      margin-top: 1rem;
      outline: none;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgb(0 0 0 / 0.15);
    }

    #msg {
      margin-top: 1.2rem;
      font-weight: 600;
      color: #0984e3;
      min-height: 1.3rem;
      user-select: none;
    }
  </style>
</head>
<body>
  <img id="logo" src="https://i.imgur.com/n0DtfkQ.jpg" alt="‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÇ‡∏•‡πÇ‡∏Å‡πâ" />
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>
  <p class="description">‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è</p>

<body>
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏≠‡πä‡∏î)" />
  <select id="group" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>

  <div class="buttons">
    <button id="start" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î (‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="play" disabled>üîä ‡∏ü‡∏±‡∏á</button>
    <button id="retry" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <canvas id="visualizer"></canvas>

  <audio id="audio" controls style="display:none;"></audio>
  <audio id="greetingAudio" src="https://natiphol.github.io/33/Test.mp3"></audio>

  <p id="msg"></p>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxE_TYcDqqheROL652jb8wHmg3K9IHujV6nwrXADVlYqX-RSJNfp1TfdyZdL4Zm7oODMw/exec";

    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const playBtn = document.getElementById("play");
    const retryBtn = document.getElementById("retry");
    const uploadBtn = document.getElementById("upload");
    const audioPlayback = document.getElementById("audio");
    const greetingAudio = document.getElementById("greetingAudio");
    const msg = document.getElementById("msg");
    const nameInput = document.getElementById("name");
    const groupSelect = document.getElementById("group");
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");

    let mediaRecorder, recordedChunks = [], audioBlob, animationId, audioContext, analyser, source, stream;
    const MAX_RECORD_TIME_MS = 180000;
    let recordTimeout;

    function resetUI() {
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
      stopBtn.disabled = true;
      playBtn.disabled = !audioBlob;
      retryBtn.disabled = !audioBlob;
      uploadBtn.disabled = !audioBlob;
      audioPlayback.style.display = audioBlob ? "block" : "none";
      msg.textContent = "";
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      clearCanvas();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#dfe6e9";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawVisualizer() {
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        ctx.fillStyle = "#dfe6e9";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#0984e3";
        ctx.beginPath();
        const sliceWidth = canvas.width / bufferLength;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = (v * canvas.height) / 2;
          i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
          x += sliceWidth;
        }
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
      }
      draw();
    }

    async function initStream() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);
        canvas.width = canvas.clientWidth;
        canvas.height = 80;
        return true;
      } catch (e) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï");
        return false;
      }
    }

    function getSupportedMimeType() {
      return ["audio/mp4", "audio/m4a", "audio/webm", "audio/ogg"].find(type => MediaRecorder.isTypeSupported(type)) || "";
    }

    async function startRecording() {
      if (!nameInput.value.trim() || !groupSelect.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°");
      if (!stream && !await initStream()) return;

      recordedChunks = [];
      const mimeType = getSupportedMimeType();
      if (!mimeType) return alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á");

      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = e => e.data.size > 0 && recordedChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(recordedChunks, { type: mimeType });
        audioPlayback.src = URL.createObjectURL(audioBlob);
        resetUI();
      };

      msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
      await new Promise(res => { greetingAudio.play(); greetingAudio.onended = res; });

      mediaRecorder.start();
      msg.textContent = "üéô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      drawVisualizer();
      startBtn.disabled = true;
      stopBtn.disabled = false;

      recordTimeout = setTimeout(() => {
        stopRecording();
        msg.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ";
      }, MAX_RECORD_TIME_MS);
    }

    function stopRecording() {
      if (mediaRecorder?.state === "recording") mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      msg.textContent = "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
    }

    startBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;
    playBtn.onclick = () => audioPlayback.src && audioPlayback.play();
    retryBtn.onclick = () => { audioBlob = null; audioPlayback.src = ""; resetUI(); msg.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà"; };
    uploadBtn.onclick = async () => {
      if (!audioBlob) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
      const filename = `${nameInput.value.trim().replace(/\s+/g, '_')}_${groupSelect.value}.m4a`;
      const formData = new FormData();
      formData.append("audio", audioBlob, filename);
      formData.append("name", nameInput.value.trim());
      formData.append("group", groupSelect.value);
      uploadBtn.disabled = true;
      uploadBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
      try {
        const response = await fetch(SCRIPT_URL, { method: "POST", body: formData });
        const result = await response.json();
        msg.textContent = result.success ? "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!" : "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (result.message || "");
      } catch (err) {
        msg.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "üì§ ‡∏™‡πà‡∏á";
      }
    };

    function checkInput() {
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
    }

    nameInput.addEventListener("input", checkInput);
    groupSelect.addEventListener("change", checkInput);

    resetUI();
  </script>
</body>
</html>
