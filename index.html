
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
<style>
  /* [style content remains unchanged from user's file] */
</style>
</head>
<body>
<header>
  <img src="https://i.imgur.com/n0DtfkQ.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á" width="150" />
</header>
<div class="container">
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>
  <label for="groupSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
  <select id="groupSelect">
    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
    <option value="groom_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <label for="nameInput">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
  <input id="nameInput" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />
  <div class="greeting" id="greetingText">
    ‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è
  </div>
  <canvas id="audioVisualizer"></canvas>
  <div class="buttons-row">
    <button id="playGreetingBtn">üì¢ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
    <button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="stopBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="retryBtn" disabled>üîÑ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="playBtn" disabled>‚ñ∂ ‡∏ü‡∏±‡∏á</button>
    <button id="uploadBtn" disabled>üì§ ‡πÅ‡∏ä‡∏£‡πå / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
  </div>
  <audio id="audioPlayback" class="audio-player" controls playsinline></audio>
</div>
<script>
const playGreetingBtn = document.getElementById('playGreetingBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const retryBtn = document.getElementById('retryBtn');
const playBtn = document.getElementById('playBtn');
const uploadBtn = document.getElementById('uploadBtn');
const nameInput = document.getElementById('nameInput');
const greetingText = document.getElementById('greetingText');
const groupSelect = document.getElementById('groupSelect');
const audioPlayback = document.getElementById('audioPlayback');
const canvas = document.getElementById('audioVisualizer');
const canvasCtx = canvas.getContext('2d');

let mediaRecorder, audioChunks = [], audioBlob, audioUrl;
let audioContext, analyser, sourceNode, animationId, recordTimeout;
const MAX_RECORD_TIME_MS = 240000;
const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

function drawVisualizer() {
  if (!analyser) return;
  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;
  const bufferLength = analyser.fftSize;
  const dataArray = new Uint8Array(bufferLength);
  canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
  analyser.getByteTimeDomainData(dataArray);
  canvasCtx.lineWidth = 3;
  canvasCtx.strokeStyle = '#004080';
  canvasCtx.beginPath();
  const sliceWidth = WIDTH / bufferLength;
  let x = 0;
  for(let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 128.0;
    const y = v * HEIGHT / 2;
    if(i === 0) canvasCtx.moveTo(x, y);
    else canvasCtx.lineTo(x, y);
    x += sliceWidth;
  }
  canvasCtx.lineTo(WIDTH, HEIGHT / 2);
  canvasCtx.stroke();
  animationId = requestAnimationFrame(drawVisualizer);
}

async function setupRecorder() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioContext = new AudioContext();
    sourceNode = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    sourceNode.connect(analyser);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioPlayback.pause();
      audioPlayback.src = '';
      audioUrl = URL.createObjectURL(audioBlob);
      audioPlayback.src = audioUrl;
      playBtn.disabled = false;
      uploadBtn.disabled = false;
      retryBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      cancelAnimationFrame(animationId);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    };
    return true;
  } catch (err) {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    return false;
  }
}

playGreetingBtn.addEventListener('click', async () => {
  greetingText.textContent = 'üéß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...';
  playGreetingBtn.disabled = true;
  await greetingAudio.play();
  greetingAudio.onended = () => {
    startBtn.disabled = false;
    greetingText.textContent = '‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ';
  };
});

startBtn.addEventListener('click', async () => {
  if (!groupSelect.value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
  if (!nameInput.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');
  if (!mediaRecorder) {
    const ready = await setupRecorder();
    if (!ready) return;
  }
  greetingText.textContent = 'üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
  startBtn.disabled = true;
  audioChunks = [];
  mediaRecorder.start();
  stopBtn.disabled = false;
  retryBtn.disabled = true;
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  drawVisualizer();
  recordTimeout = setTimeout(() => {
    if (mediaRecorder?.state === 'recording') {
      mediaRecorder.stop();
      greetingText.textContent = '‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 4 ‡∏ô‡∏≤‡∏ó‡∏µ';
    }
  }, MAX_RECORD_TIME_MS);
});

stopBtn.addEventListener('click', () => {
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
    greetingText.textContent = 'üìç ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß';
  }
});

retryBtn.addEventListener('click', () => {
  audioPlayback.pause();
  audioPlayback.src = '';
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  retryBtn.disabled = true;
  greetingText.textContent = '‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è';
});

playBtn.addEventListener('click', async () => {
  if (audioPlayback.src) {
    try {
      audioPlayback.load(); // üîß iOS fix
      await audioPlayback.play();
    } catch (error) {
      console.log('Error playing audio:', error);
    }
  }
});

uploadBtn.addEventListener('click', async () => {
  if (!audioBlob || !nameInput.value.trim() || !groupSelect.value) return;
  const formData = new FormData();
  formData.append('audioBlob', audioBlob, 'voice.webm');
  formData.append('name', nameInput.value.trim());
  formData.append('group', groupSelect.value);
  uploadBtn.disabled = true;
  greetingText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
  try {
    const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
      method: 'POST', body: formData
    });
    const text = await response.text();
    greetingText.textContent = text.includes('success')
      ? '‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      : '‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
  } catch (err) {
    greetingText.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
  }
});

function resizeCanvas() {
  canvas.width = canvas.clientWidth * window.devicePixelRatio;
  canvas.height = canvas.clientHeight * window.devicePixelRatio;
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', () => resizeCanvas());
</script>
</body>
</html>
