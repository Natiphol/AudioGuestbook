<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    canvas { width: 100%; height: 100px; border: 1px solid #ccc; margin: 1rem 0; }
    button { margin: 0.5rem; padding: 1rem; font-size: 1rem; }
    input, select { padding: 0.5rem; margin: 0.5rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h2>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h2>
  <p id="greeting">‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
  
  <select id="group">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="A">‡∏Å‡∏•‡∏∏‡πà‡∏° A</option>
    <option value="B">‡∏Å‡∏•‡∏∏‡πà‡∏° B</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"/>

  <div>
    <button id="start">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="play" disabled>üîä ‡∏ü‡∏±‡∏á</button>
    <button id="retry" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <canvas id="visualizer" width="500" height="100"></canvas>
  <audio id="audio" controls style="width: 100%; display:none;"></audio>

  <!-- Recorder.js (inline version) -->
  <script>
(function(window){var WORKER_PATH='data:application/javascript;base64,'+
  btoa(`self.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type);break;case"clear":clear();break;}};
  var recLength=0,recBuffers=[],sampleRate;
  function init(config){sampleRate=config.sampleRate;}
  function record(inputBuffer){recBuffers.push(inputBuffer[0]);recLength+=inputBuffer[0].length;}
  function exportWAV(type){var buffer=mergeBuffers(recBuffers,recLength);var dataview=encodeWAV(buffer);var audioBlob=new Blob([dataview],{type:type});self.postMessage(audioBlob);}
  function clear(){recLength=0;recBuffers=[];}
  function mergeBuffers(recBuffers,recLength){var result=new Float32Array(recLength);var offset=0;for(var i=0;i<recBuffers.length;i++){result.set(recBuffers[i],offset);offset+=recBuffers[i].length;}return result;}
  function floatTo16BitPCM(output,offset,input){for(var i=0;i<input.length;i++){var s=Math.max(-1,Math.min(1,input[i]));output.setInt16(offset,s<0?s*0x8000:s*0x7FFF,true);offset+=2;}}
  function writeString(view,offset,string){for(var i=0;i<string.length;i++){view.setUint8(offset+i,string.charCodeAt(i));}}
  function encodeWAV(samples){var buffer=new ArrayBuffer(44+samples.length*2);var view=new DataView(buffer);
  writeString(view,0,'RIFF');view.setUint32(4,36+samples.length*2,true);writeString(view,8,'WAVE');
  writeString(view,12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,1,true);
  view.setUint32(24,sampleRate,true);view.setUint32(28,sampleRate*2,true);view.setUint16(32,2,true);view.setUint16(34,16,true);
  writeString(view,36,'data');view.setUint32(40,samples.length*2,true);floatTo16BitPCM(view,44,samples);
  return view;}`); // inline worker

window.Recorder=function(source,config){var cfg=config||{};var bufferLen=cfg.bufferLen||4096;
this.context=source.context;this.node=this.context.createScriptProcessor(bufferLen,2,2);
var worker=new Worker(WORKER_PATH);worker.postMessage({command:'init',config:{sampleRate:this.context.sampleRate}});
var recording=false;var currCallback;
this.node.onaudioprocess=function(e){if(!recording)return;
worker.postMessage({command:'record',buffer:[e.inputBuffer.getChannelData(0)]});};
this.record=function(){recording=true;};
this.stop=function(){recording=false;};
this.clear=function(){worker.postMessage({command:'clear'});};
this.exportWAV=function(cb,type){currCallback=cb;worker.onmessage=function(e){currCallback(e.data);};
worker.postMessage({command:'exportWAV',type:type||'audio/wav'});};
source.connect(this.node);this.node.connect(this.context.destination);};
})(window);
  </script>

  <!-- Script ‡∏´‡∏•‡∏±‡∏Å -->
  <script>
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const playBtn = document.getElementById("play");
const retryBtn = document.getElementById("retry");
const uploadBtn = document.getElementById("upload");
const audioPlayback = document.getElementById("audio");
const greetingText = document.getElementById("greeting");
const nameInput = document.getElementById("name");
const groupSelect = document.getElementById("group");
const canvas = document.getElementById("visualizer");
const canvasCtx = canvas.getContext("2d");

let recorder, audioBlob, audioUrl;
let audioContext, analyser, sourceNode, animationId, recordTimeout;

const MAX_RECORD_TIME_MS = 240000; // 4 ‡∏ô‡∏≤‡∏ó‡∏µ

async function setupRecorder() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    sourceNode.connect(analyser);
    recorder = new Recorder(sourceNode);
    return true;
  } catch (err) {
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
    return false;
  }
}

function drawVisualizer() {
  const bufferLength = analyser.fftSize;
  const dataArray = new Uint8Array(bufferLength);

  function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(dataArray);
    canvasCtx.fillStyle = "white";
    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = "blue";
    canvasCtx.beginPath();
    const sliceWidth = canvas.width / bufferLength;
    let x = 0;
    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 128.0;
      const y = (v * canvas.height) / 2;
      i === 0 ? canvasCtx.moveTo(x, y) : canvasCtx.lineTo(x, y);
      x += sliceWidth;
    }
    canvasCtx.lineTo(canvas.width, canvas.height / 2);
    canvasCtx.stroke();
  }
  draw();
}

function stopRecording() {
  recorder.stop();
  recorder.exportWAV((blob) => {
    audioBlob = blob;
    audioPlayback.pause();
    audioPlayback.src = "";
    audioUrl = URL.createObjectURL(audioBlob);
    audioPlayback.src = audioUrl;
    audioPlayback.style.display = "block";

    playBtn.disabled = false;
    uploadBtn.disabled = false;
    retryBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.disabled = false;
    cancelAnimationFrame(animationId);
    canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
    clearTimeout(recordTimeout);
  });
}

startBtn.addEventListener("click", async () => {
  if (!groupSelect.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
  if (!nameInput.value.trim()) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  if (!recorder) {
    const ready = await setupRecorder();
    if (!ready) return;
  }

  greetingText.textContent = "üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
  startBtn.disabled = true;
  recorder.clear();
  recorder.record();
  stopBtn.disabled = false;
  retryBtn.disabled = true;
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  drawVisualizer();
  recordTimeout = setTimeout(() => {
    stopRecording();
    greetingText.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 4 ‡∏ô‡∏≤‡∏ó‡∏µ";
  }, MAX_RECORD_TIME_MS);
});

stopBtn.addEventListener("click", () => {
  stopRecording();
  greetingText.textContent = "üìç ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
});

retryBtn.addEventListener("click", () => {
  audioPlayback.src = "";
  playBtn.disabled = true;
  retryBtn.disabled = true;
  uploadBtn.disabled = true;
  greetingText.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
});

playBtn.addEventListener("click", () => {
  if (audioUrl) {
    audioPlayback.play();
  }
});

uploadBtn.addEventListener("click", async () => {
  if (!audioBlob) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
  const formData = new FormData();
  formData.append("audio", audioBlob, "voice.wav");
  formData.append("name", nameInput.value.trim());
  formData.append("group", groupSelect.value);

  uploadBtn.disabled = true;
  uploadBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

  try {
    const response = await fetch("/upload", { method: "POST", body: formData });
    const result = await response.json();
    if (result.success) {
      alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      greetingText.textContent = "‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á!";
    } else {
      throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    }
  } catch (err) {
    alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = "üì§ ‡∏™‡πà‡∏á";
  }
});
  </script>
</body>
</html>
